{% load module_template_tags sekizai_tags static thumbnail menu_tags editor_template_tags %}

<div class='lesson'>

    {% if edit_access %}
        <button class="Toggle_edit_btn btn btn-default">Edit</button>
    {% else %}
        <div class="HL-message-banner warning"> {{ manage_denied_message }}</div>
    {% endif %}

    {% if is_instance %}
        {# if there's a form instance display it's content as it would be in the viewer #}
        <div class="content_block">

            {# content_editor_button request.user object #}
            <div id="manage_form" style="width:100%; border:none;"></div>

        </div>
    {% endif %}

    {% if edit_access %}
        <div class="form_block" data-existing-instance="{{ is_instance }}">
            <div id="content_form_success" class="HL-message-banner success form_messages"></div>
            <div id="content_form_errors" class="HL-message-banner critical form_messages"></div>

            <h2 class="lesson-header">
                Editing:
                {% if is_instance %}
                    {{form.instance.name}}
                {% else %}
                    New Lesson
                {% endif %}
            </h2>
            <hr class="headerSpacer">

            <form id="content_form" action="{{ request.path }}" method="post">
                {% csrf_token %}
                {{ form.media }}
                <table>
                    {{ form.as_table }}
                </table>
                <div>
                    {% for map in existing_objectives %}
                        {% for pk,objective in map.items %}
                            <div pk="{{ pk }}">{{ objective }}</div>
                        {% endfor %}
                    {% endfor %}
                </div>
                <div id="learning_outcomes_formset" class="LO_form">
                    <div id="LO_Empty_form">
                        <div class="LO_representation"></div>
                        {{ learning_objective_formset.empty_form }}
                    </div>
                    <div class="learning_obj_form empty_form" method="post">
                        {{ learning_objective_formset.management_form }}
                        {% for lo_form in  learning_objective_formset %}
                            <div class="LO_form">
                                <div class="LO_representation"></div>
                                {{ lo_form }}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <div id="content_form_controls">
                    <button class="Submit_button btn btn-default" type="submit">Submit Lesson</button>
                    <button class="Cancel_button btn btn-default">Cancel</button>

                    {% if is_instance %}
                        <button class="Delete_button btn btn-default" data-slug="form.instance.slug"><i class="fas fa-trash"></i> Delete Lesson</button>
                    {% endif %}
                </div>
            </form>
            <div>
                <button id="add-objective-btn">Add</button>
            </div>
        </div>
    {% endif %}

</div>


        <link rel="stylesheet" href="{% static 'css/normalize.css' %}">
        <link rel="stylesheet" href="{% static 'css/main.css' %}">
        <link rel="stylesheet" href="{% static 'css/jquery.steps.css' %}">
        <script src="{% static 'js/plugins/modernizr-2.6.2.min.js' %}"></script>
        <script src="{% static 'js/plugins/jquery.cookie-1.3.1.js' %}"></script>
        <script src="{% static 'js/plugins/jquery.steps.js' %}"></script>
        <script src="{% static 'js/plugins/jquery.formset.js' %}"></script>
        <script type='text/javascript'>
            $( function() {
                lo_dialog = $( "#learning-objective-dialog" ).dialog({
                    autoOpen: false,
                    width: 1200,
                    modal: true,
                    close: function() {
                        //TODO handle form here?
                    }
                });

                $("#add-objective-btn").click(function( event ) {
                    lo_dialog.dialog( "open" );
                } );
            } );

            $('.LO_form').formset({

                formCssClass: "LO_form",

                // add prefix for formset (you can comment this out for now, but you will
                // need to add this once it’s part of the lesson form)
                // prefix: '{{ learning_objective_formset.prefix }}',

                // this will remove the text from the add button so you don’t need to hide it
                addText: "",

                // specify the empty form representation
                formTemplate: "#LO_Empty_form",
            });

            // remove the inital row... TODO, this will be removed when we're hooked into the backend?
            $('.delete-row').click()
        </script>